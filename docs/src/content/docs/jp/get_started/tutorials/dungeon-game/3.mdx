---
title: "AIãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã‚²ãƒ¼ãƒ "
description: "@aws/nx-pluginã‚’ä½¿ç”¨ã—ã¦AIãƒ‘ãƒ¯ãƒ¼ãƒ‰ã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†’é™ºã‚²ãƒ¼ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹æ–¹æ³•ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«3: Story APIã®å®Ÿè£…

<Aside type="caution">
**Anthropic Claude 3.5 Sonnet v2**ãƒ¢ãƒ‡ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒ[ã“ã®ã‚¬ã‚¤ãƒ‰](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html)ã«è¨˜è¼‰ã®æ‰‹é †ã§è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
</Aside>

StoryApiã¯ã€`Game`ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç”¨ã®`Action`ãƒªã‚¹ãƒˆã‚’å—ã‘å–ã‚Šã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’é€²è¡Œã•ã›ã‚‹å˜ä¸€ã®API `generate_story`ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚ã“ã®APIã¯Python/FastAPIã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°APIã¨ã—ã¦å®Ÿè£…ã•ã‚Œã€ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ç›®çš„ã«åˆã‚ã›ã¦å¤‰æ›´ã™ã‚‹æ–¹æ³•ã‚‚å®Ÿæ¼”ã—ã¾ã™ã€‚

### APIå®Ÿè£…

APIã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ã¾ãšè¿½åŠ ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- `boto3`: Amazon Bedrockã®å‘¼ã³å‡ºã—ã«ä½¿ç”¨
- `uvicorn`: [Lambda Web Adapter (LWA)](https://github.com/awslabs/aws-lambda-web-adapter)ã¨çµ„ã¿åˆã‚ã›ã¦APIèµ·å‹•ã«ä½¿ç”¨
- `copyfiles`: ãƒãƒ³ãƒ‰ãƒ«ã‚¿ã‚¹ã‚¯æ›´æ–°æ™‚ã«ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹npmä¾å­˜é–¢ä¿‚

ã“ã‚Œã‚‰ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

<NxCommands commands={["run dungeon_adventure.story_api:add --args boto3 uvicorn"]} />
<InstallCommand pkg="copyfiles" dev />

æ¬¡ã«ã€`packages/story_api/story_api`å†…ã®ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç½®ãæ›ãˆã¾ã™ï¼š

<Tabs>
<TabItem label="main.py">
```python
// packages/story_api/story_api/main.py
import json

from boto3 import client
from fastapi.responses import PlainTextResponse, StreamingResponse
from pydantic import BaseModel

from .init import app, lambda_handler

handler = lambda_handler

bedrock = client('bedrock-runtime')

class Action(BaseModel):
    role: str
    content: str

class StoryRequest(BaseModel):
    genre: str
    playerName: str
    actions: list[Action]

async def bedrock_stream(request: StoryRequest):
    messages = [
        {"role": "user", "content": "Continue or create a new story..."}
    ]

    for action in request.actions:
        messages.append({"role": action.role, "content": action.content})

    response = bedrock.invoke_model_with_response_stream(
        modelId='anthropic.claude-3-sonnet-20240229-v1:0',
        body=json.dumps({
            "system":f"""
            You are running an AI text adventure game in the {request.genre} genre.
            Player: {request.playerName}. Return less than 200 characters of text.
            """,
            "messages": messages,
            "max_tokens": 1000,
            "temperature": 0.7,
            "anthropic_version": "bedrock-2023-05-31"
        })
    )

    stream = response.get('body')
    if stream:
        for event in stream:
            chunk = event.get('chunk')
            if chunk:
                message = json.loads(chunk.get("bytes").decode())
                if message['type'] == "content_block_delta":
                    yield message['delta']['text'] or ""
                elif message['type'] == "message_stop":
                    yield "\n"

@app.post("/story/generate",
          openapi_extra={'x-streaming': True},
          response_class=PlainTextResponse)
def generate_story(request: StoryRequest) -> str:
    return StreamingResponse(bedrock_stream(request), media_type="text/plain")
```
</TabItem>
<TabItem label="init.py">
```python
// packages/story_api/story_api/init.py
import os
import uuid
from collections.abc import Callable

from aws_lambda_powertools import Logger, Metrics, Tracer
from aws_lambda_powertools.metrics import MetricUnit
from fastapi import FastAPI, Request, Response
from fastapi.openapi.utils import get_openapi
from fastapi.responses import JSONResponse
from fastapi.routing import APIRoute
from mangum import Mangum
from pydantic import BaseModel
from starlette.middleware.exceptions import ExceptionMiddleware

os.environ["POWERTOOLS_METRICS_NAMESPACE"] = "StoryApi"
os.environ["POWERTOOLS_SERVICE_NAME"] = "StoryApi"

logger: Logger = Logger()
metrics: Metrics = Metrics()
tracer: Tracer = Tracer()

class InternalServerErrorDetails(BaseModel):
    detail: str

app = FastAPI(
    title="StoryApi",
    responses={
        500: {"model": InternalServerErrorDetails}
    }
)
lambda_handler = Mangum(app)

# Add tracing
lambda_handler.__name__ = "handler"  # tracer requires __name__ to be set
lambda_handler = tracer.capture_lambda_handler(lambda_handler)
# Add logging
lambda_handler = logger.inject_lambda_context(lambda_handler, clear_state=True)
# Add metrics last to properly flush metrics.
lambda_handler = metrics.log_metrics(lambda_handler, capture_cold_start_metric=True)

# Add exception middleware(s)
app.add_middleware(ExceptionMiddleware, handlers=app.exception_handlers)

@app.exception_handler(Exception)
async def unhandled_exception_handler(request, err):
    logger.exception("Unhandled exception")

    metrics.add_metric(name="Failure", unit=MetricUnit.Count, value=1)

    return JSONResponse(status_code=500,
                        content=InternalServerErrorDetails(
                            detail="Internal Server Error").model_dump())

@app.middleware("http")
async def metrics_handler(request: Request, call_next):
    metrics.add_dimension("route", f"{request.method} {request.url.path}")
    metrics.add_metric(name="RequestCount", unit=MetricUnit.Count, value=1)

    response = await call_next(request)

    if response.status_code == 200:
        metrics.add_metric(name="Success", unit=MetricUnit.Count, value=1)

    return response

# Add correlation id middleware
@app.middleware("http")
async def add_correlation_id(request: Request, call_next):
    # Get correlation id from X-Correlation-Id header
    corr_id = request.headers.get("x-correlation-id")
    if not corr_id and "aws.context" in request.scope:
        # If empty, use request id from aws context
        corr_id = request.scope["aws.context"].aws_request_id
    elif not corr_id:
        # If still empty, use uuid
        corr_id = uuid.uuid4().hex

    # Add correlation id to logs
    logger.set_correlation_id(corr_id)

    response = await call_next(request)

    # Return correlation header in response
    response.headers["X-Correlation-Id"] = corr_id
    return response

class LoggerRouteHandler(APIRoute):
    def get_route_handler(self) -> Callable:
        original_route_handler = super().get_route_handler()

        async def route_handler(request: Request) -> Response:
            # Add fastapi context to logs
            ctx = {
                "path": request.url.path,
                "route": self.path,
                "method": request.method,
            }
            logger.append_keys(fastapi=ctx)
            logger.info("Received request")

            return await original_route_handler(request)

        return route_handler

app.router.route_class = LoggerRouteHandler

def custom_openapi():
    if app.openapi_schema:
        return app.openapi_schema
    for route in app.routes:
        if isinstance(route, APIRoute):
            route.operation_id = route.name
    openapi_schema = get_openapi(
        title=app.title,
        version=app.version,
        openapi_version=app.openapi_version,
        description=app.description,
        routes=app.routes,
    )
    app.openapi_schema = openapi_schema
    return app.openapi_schema

app.openapi = custom_openapi

```

:::note
ä¸Šè¨˜ã®`init.py`ã¸ã®å¤‰æ›´ã¯ã€CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å‰Šé™¤ã—ã¦Lambda Function URLç‹¬è‡ªã®CORSãƒ˜ãƒƒãƒ€ãƒ¼å‡¦ç†ã¨ã®ç«¶åˆã‚’é˜²ããŸã‚ã®ã‚‚ã®ã§ã™ã€‚
:::

</TabItem>
</Tabs>

ã‚³ãƒ¼ãƒ‰åˆ†æï¼š

- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSDKç”Ÿæˆæ™‚ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°APIã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™`x-streaming`è¨­å®šã‚’ä½¿ç”¨
- `media_type="text/plain"`ã¨`response_class=PlainTextResponse`ã§å®šç¾©ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’è¿”ã™

:::note
FastAPIã«å¤‰æ›´ã‚’åŠ ãˆã‚‹ãŸã³ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®ç”Ÿæˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«åæ˜ ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

å¾Œã»ã©ã•ã‚‰ã«å¤‰æ›´ã‚’åŠ ãˆã¦ã‹ã‚‰å†ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚
:::

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

<Link path="get_started/tutorials/dungeon-game/1#game-ui-infrastructure">ä»¥å‰è¨­å®šã—ãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£</Link>ã¯ã€ã™ã¹ã¦ã®APIãŒLambdaé–¢æ•°ã¨çµ±åˆã™ã‚‹API Gatewayã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚`story_api`ã§ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚µãƒãƒ¼ãƒˆã—ãªã„ãŸã‚ã€[ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œã®Lambda Function URL](https://docs.aws.amazon.com/lambda/latest/dg/configuration-response-streaming.html)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

CDKã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›´æ–°ã—ã¾ã™ï¼š

<Tabs>
<TabItem label="story-api.ts">
```ts
// packages/common/constructs/src/app/apis/story-api.ts
import { Duration, Stack, CfnOutput } from 'aws-cdk-lib';
import { IGrantable, Grant } from 'aws-cdk-lib/aws-iam';
import {
  Runtime,
  Code,
  Tracing,
  LayerVersion,
  FunctionUrlAuthType,
  InvokeMode,
  Function,
} from 'aws-cdk-lib/aws-lambda';
import { Construct } from 'constructs';
import url from 'url';
import { RuntimeConfig } from '../../core/runtime-config.js';

export class StoryApi extends Construct {
  public readonly handler: Function;

  constructor(scope: Construct, id: string) {
    super(scope, id);

    this.handler = new Function(this, 'Handler', {
      runtime: Runtime.PYTHON_3_12,
      handler: 'run.sh',
      code: Code.fromAsset(
        url.fileURLToPath(
          new URL(
            '../../../../../../dist/packages/story_api/bundle',
            import.meta.url,
          ),
        ),
      ),
      timeout: Duration.seconds(30),
      tracing: Tracing.ACTIVE,
      environment: {
        AWS_CONNECTION_REUSE_ENABLED: '1',
      },
    });

    const stack = Stack.of(this);
    this.handler.addLayers(
      LayerVersion.fromLayerVersionArn(
        this,
        'LWALayer',
        `arn:aws:lambda:${stack.region}:753240598075:layer:LambdaAdapterLayerX86:24`,
      ),
    );
    this.handler.addEnvironment('PORT', '8000');
    this.handler.addEnvironment('AWS_LWA_INVOKE_MODE', 'response_stream');
    this.handler.addEnvironment('AWS_LAMBDA_EXEC_WRAPPER', '/opt/bootstrap');
    const functionUrl = this.handler.addFunctionUrl({
      authType: FunctionUrlAuthType.AWS_IAM,
      invokeMode: InvokeMode.RESPONSE_STREAM,
      cors: {
        allowedOrigins: ['*'],
        allowedHeaders: [
          'authorization',
          'content-type',
          'x-amz-content-sha256',
          'x-amz-date',
          'x-amz-security-token',
        ],
      },
    });

    new CfnOutput(this, 'StoryApiUrl', { value: functionUrl.url });

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªç”¨ã«å®Ÿè¡Œæ™‚è¨­å®šã«API URLã‚’ç™»éŒ²
    RuntimeConfig.ensure(this).config.apis = {
      ...RuntimeConfig.ensure(this).config.apis!,
      StoryApi: functionUrl.url,
    };
  }

  public grantInvokeAccess(grantee: IGrantable) {
    Grant.addToPrincipal({
      grantee,
      actions: ['lambda:InvokeFunctionUrl'],
      resourceArns: [this.handler.functionArn],
      conditions: {
        StringEquals: {
          'lambda:FunctionUrlAuthType': 'AWS_IAM',
        },
      },
    });
  }
}

```
</TabItem>
<TabItem label="application-stack.ts">
```diff lang="typescript"
// packages/infra/src/stacks/application-stack.ts
import {
  GameApi,
  GameUI,
  StoryApi,
  UserIdentity,
} from ':dungeon-adventure/common-constructs';
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { ElectrodbDynamoTable } from '../constructs/electrodb-table.js';
+import { PolicyStatement, Effect } from 'aws-cdk-lib/aws-iam';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // The code that defines your stack goes here
    const userIdentity = new UserIdentity(this, 'UserIdentity');

    const electroDbTable = new ElectrodbDynamoTable(this, 'ElectroDbTable');

    const gameApi = new GameApi(this, 'GameApi', {
      integrations: GameApi.defaultIntegrations(this)
        .withDefaultOptions({
          environment: {
            TABLE_NAME: electroDbTable.tableName,
          },
        })
        .build(),
    });

    // Grant read/write access to each handler depending on the permissions it requires
    electroDbTable.grantReadData(gameApi.integrations['actions.query'].handler);
    electroDbTable.grantReadData(gameApi.integrations['games.query'].handler);
    electroDbTable.grantReadWriteData(
      gameApi.integrations['actions.save'].handler,
    );
    electroDbTable.grantReadWriteData(
      gameApi.integrations['games.save'].handler,
    );

-    const storyApi = new StoryApi(this, 'StoryApi', {
-      integrations: StoryApi.defaultIntegrations(this).build(),
-    });
+    const storyApi = new StoryApi(this, 'StoryApi');
+    storyApi.handler.addToRolePolicy(
+      new PolicyStatement({
+        effect: Effect.ALLOW,
+        actions: ['bedrock:InvokeModelWithResponseStream'],
+        resources: [
+          'arn:aws:bedrock:*::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0',
+        ],
+      }),
+    );

    // grant our authenticated role access to invoke our APIs
    [storyApi, gameApi].forEach((api) =>
      api.grantInvokeAccess(userIdentity.identityPool.authenticatedRole),
    );

    // Ensure this is instantiated last so our runtime-config.json can be automatically configured
    new GameUI(this, 'GameUI');
  }
}

```
</TabItem>
</Tabs>

[Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚`story_api`ã‚’æ›´æ–°ã—ã¾ã™ï¼š

<Tabs>
<TabItem label="run.sh">
```bash
// packages/story_api/run.sh
#!/bin/bash

PATH=$PATH:$LAMBDA_TASK_ROOT/bin \
    PYTHONPATH=$PYTHONPATH:/opt/python:$LAMBDA_RUNTIME_DIR \
    exec python -m uvicorn --port=$PORT story_api.main:app
```
</TabItem>
<TabItem label="project.json">
```diff lang="json"
// packages/story_api/project.json
{
  "name": "dungeon_adventure.story_api",
  "$schema": "../../node_modules/nx/schemas/project-schema.json",
  "projectType": "application",
  "sourceRoot": "packages/story_api/story_api",
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/story_api/bundle"],
      "options": {
        "commands": [
          "uv export --frozen --no-dev --no-editable --project story_api -o dist/packages/story_api/bundle/requirements.txt",
          "uv pip install -n --no-installer-metadata --no-compile-bytecode --python-platform x86_64-manylinux2014 --python `uv python pin` --target dist/packages/story_api/bundle -r dist/packages/story_api/bundle/requirements.txt",
+          "copyfiles -f packages/story_api/run.sh dist/packages/story_api/bundle"
        ],
        "parallel": false
      },
      "dependsOn": ["compile"]
    },
    ...
  }
}
```
</TabItem>
</Tabs>

### ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ†ã‚¹ãƒˆ

ã¾ãšã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
ãƒªãƒ³ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è‡ªå‹•ä¿®æ­£ã§ãã¾ã™ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç´„2åˆ†ã‹ã‹ã‚Šã¾ã™ã€‚

<Drawer title="ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰" trigger="ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä¸€åº¦ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚è©³ç´°ã¯ã“ã¡ã‚‰ã‚’ã‚¯ãƒªãƒƒã‚¯">

æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§CDKã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

ãŸã ã—ã€æœ¬ç•ªç’°å¢ƒç”¨ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆä¾‹ï¼š`infra-prod`ï¼‰ã‚’åˆ†é›¢ã—ã¦ã„ã‚‹å ´åˆã€`--all`ãƒ•ãƒ©ã‚°ã¯æ„å›³ã—ãªã„ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚**æ¨å¥¨ã—ã¾ã›ã‚“**

</Drawer>

ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆä¸€éƒ¨ã®å€¤ã¯ç·¨é›†æ¸ˆã¿ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX = https://xxx.lambda-url.ap-southeast-2.on.aws/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

APIã¯ä»¥ä¸‹ã®æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆã§ãã¾ã™ï¼š
<ul>
<li>FastAPIã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§èµ·å‹•ã—`curl`ã§APIã‚’å‘¼ã³å‡ºã™</li>
<li>
<Drawer title="Sigv4å¯¾å¿œcurl" trigger="ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿APIã‚’sigv4å¯¾å¿œcurlã§ç›´æ¥å‘¼ã³å‡ºã™">
`.bashrc`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ï¼ˆ`source`ã§åæ˜ ï¼‰ã™ã‚‹ã‹ã€å®Ÿè¡Œã™ã‚‹ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ç›´æ¥è²¼ã‚Šä»˜ã‘ã¾ã™ï¼š
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

sigv4èªè¨¼æ¸ˆã¿curlãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä¾‹ï¼š

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°Lambdaé–¢æ•°URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="ãƒ­ãƒ¼ã‚«ãƒ«">
  æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«FastAPIã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼š
    <NxCommands commands={["run dungeon_adventure.story_api:serve"]} />

    ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‘¼ã³å‡ºã—ï¼š

    ```bash
    curl -N -X POST http://127.0.0.1:8000/story/generate \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿">
```bash "https://xxx.lambda-url.ap-southeast-2.on.aws/" "ap-southeast-2"
acurl ap-southeast-2 lambda -N -X POST \
  https://xxx.lambda-url.ap-southeast-2.on.aws/story/generate \
  -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
  -H "Content-Type: application/json"
```
    <Aside type="caution">
    CDKãƒ‡ãƒ—ãƒ­ã‚¤å‡ºåŠ›ã®`dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX`å€¤ã‚’ä½¿ç”¨ã—ã¦URLãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’ç½®æ›ã—ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é©åˆ‡ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚
    </Aside>
  </TabItem>
</Tabs>

ã‚³ãƒãƒ³ãƒ‰ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
UnnamedHero stood tall, his cape billowing in the wind....
```

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ã€‚FastAPIã‚’ä½¿ç”¨ã—ãŸåˆã‚ã¦ã®APIã‚’æ§‹ç¯‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã—ãŸï¼ ğŸ‰ğŸ‰ğŸ‰
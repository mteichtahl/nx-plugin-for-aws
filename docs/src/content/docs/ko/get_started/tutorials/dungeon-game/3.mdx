---
title: "AI ë˜ì „ ê²Œì„"
description: "@aws/nx-pluginì„ ì‚¬ìš©í•˜ì—¬ AI ê¸°ë°˜ ë˜ì „ ëª¨í—˜ ê²Œì„ì„ êµ¬ì¶•í•˜ëŠ” ë°©ë²•ì— ëŒ€í•œ ì•ˆë‚´"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## ëª¨ë“ˆ 3: ìŠ¤í† ë¦¬ API êµ¬í˜„

<Aside type="caution">
[ì´ ê°€ì´ë“œ](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html)ì— ì„¤ëª…ëœ ë‹¨ê³„ì— ë”°ë¼ **Anthropic Claude 3.5 Sonnet v2** ëª¨ë¸ì— ëŒ€í•œ ì•¡ì„¸ìŠ¤ ê¶Œí•œì„ ë¶€ì—¬í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
</Aside>

StoryApiëŠ” `Game`ê³¼ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ„í•œ `Action` ëª©ë¡ì„ ì…ë ¥ë°›ì•„ ìŠ¤í† ë¦¬ë¥¼ ì§„í–‰í•˜ëŠ” ë‹¨ì¼ API `generate_story`ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. ì´ APIëŠ” Python/FastAPIë¡œ êµ¬í˜„ëœ ìŠ¤íŠ¸ë¦¬ë° APIì´ë©°, ìƒì„±ëœ ì½”ë“œë¥¼ ëª©ì ì— ë§ê²Œ ìˆ˜ì •í•˜ëŠ” ë°©ë²•ì„ ì¶”ê°€ë¡œ ì‹œì—°í•©ë‹ˆë‹¤.

### API êµ¬í˜„

APIë¥¼ ìƒì„±í•˜ê¸° ì „ì— ëª‡ ê°€ì§€ ì¶”ê°€ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

- `boto3`ëŠ” Amazon Bedrock í˜¸ì¶œì— ì‚¬ìš©ë©ë‹ˆë‹¤
- `uvicorn`ì€ [Lambda Web Adapter (LWA)](https://github.com/awslabs/aws-lambda-web-adapter)ì™€ í•¨ê»˜ ì‚¬ìš© ì‹œ API ì‹œì‘ì— í™œìš©ë©ë‹ˆë‹¤
- `copyfiles`ëŠ” `bundle` ì‘ì—… ì—…ë°ì´íŠ¸ ì‹œ í¬ë¡œìŠ¤ í”Œë«í¼ íŒŒì¼ ë³µì‚¬ë¥¼ ì§€ì›í•˜ê¸° ìœ„í•œ npm ì¢…ì†ì„±ì…ë‹ˆë‹¤

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•˜ì„¸ìš”:

<NxCommands commands={["run dungeon_adventure.story_api:add --args boto3 uvicorn"]} />
<InstallCommand pkg="copyfiles" dev />

ì´ì œ `packages/story_api/story_api` ë‚´ ë‹¤ìŒ íŒŒì¼ë“¤ì˜ ë‚´ìš©ì„ êµì²´í•©ë‹ˆë‹¤:

<Tabs>
<TabItem label="main.py">
<E2ECode path="dungeon-adventure/3/main.py.template" lang="python" />
</TabItem>
<TabItem label="init.py">
<E2ECode path="dungeon-adventure/3/init.py.template" lang="python" />

:::note
ìœ„ì˜ `init.py` ë³€ê²½ì‚¬í•­ì€ Lambda Function URLì˜ ìì²´ CORS í—¤ë” ì²˜ë¦¬ì™€ì˜ ì¶©ëŒì„ ë°©ì§€í•˜ê¸° ìœ„í•´ CORS ë¯¸ë“¤ì›¨ì–´ë¥¼ ì œê±°í•˜ëŠ” ë‹¨ìˆœí•œ ìˆ˜ì •ì…ë‹ˆë‹¤.
:::

</TabItem>
</Tabs>

ìƒê¸° ì½”ë“œ ë¶„ì„:

- í´ë¼ì´ì–¸íŠ¸ SDK ìƒì„± ì‹œ ìŠ¤íŠ¸ë¦¬ë° APIì„ì„ ë‚˜íƒ€ë‚´ê¸° ìœ„í•´ `x-streaming` ì„¤ì •ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ëŠ” íƒ€ì… ì•ˆì „ì„±ì„ ìœ ì§€í•˜ë©´ì„œ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ APIë¥¼ ì†Œë¹„í•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤
- APIëŠ” `media_type="text/plain"`ê³¼ `response_class=PlainTextResponse`ë¡œ ì •ì˜ëœ í…ìŠ¤íŠ¸ ìŠ¤íŠ¸ë¦¼ì„ ë°˜í™˜í•©ë‹ˆë‹¤

:::note
FastAPIì— ë³€ê²½ì‚¬í•­ì„ ì ìš©í•  ë•Œë§ˆë‹¤ ì›¹ì‚¬ì´íŠ¸ì˜ ìƒì„±ëœ í´ë¼ì´ì–¸íŠ¸ì— ë°˜ì˜ë˜ë„ë¡ í”„ë¡œì íŠ¸ë¥¼ ì¬ë¹Œë“œí•´ì•¼ í•©ë‹ˆë‹¤.

ì•„ë˜ì—ì„œ ëª‡ ê°€ì§€ ì¶”ê°€ ë³€ê²½ì„ ìˆ˜í–‰í•œ í›„ ì¬ë¹Œë“œí•˜ê² ìŠµë‹ˆë‹¤.
:::

### ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜

<Link path="get_started/tutorials/dungeon-game/1#game-ui-infrastructure">ì´ì „ì— ì„¤ì •í•œ ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜</Link>ëŠ” ëª¨ë“  APIê°€ Lambda í•¨ìˆ˜ì™€ í†µí•©í•˜ëŠ” API Gatewayë¥¼ ì‚¬ìš©í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤. `story_api`ì˜ ê²½ìš° ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” API Gateway ëŒ€ì‹  [ì‘ë‹µ ìŠ¤íŠ¸ë¦¬ë°ì´ êµ¬ì„±ëœ Lambda Function URL](https://docs.aws.amazon.com/lambda/latest/dg/configuration-response-streaming.html)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

ì´ë¥¼ ì§€ì›í•˜ê¸° ìœ„í•´ ë¨¼ì € CDK êµ¬ì„±ì„ ë‹¤ìŒê³¼ ê°™ì´ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤:

<Tabs>
<TabItem label="story-api.ts">
<E2ECode path="dungeon-adventure/3/story-api.ts.template" lang="typescript" />
</TabItem>
<TabItem label="application-stack.ts">
<E2EDiff before="dungeon-adventure/2/stacks/application-stack.ts.template" after="dungeon-adventure/3/application-stack.ts.template" lang="typescript" />
</TabItem>
</Tabs>

ì´ì œ [Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter) ë°°í¬ë¥¼ ì§€ì›í•˜ë„ë¡ `story_api`ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.

<Tabs>
<TabItem label="run.sh">
<E2ECode path="dungeon-adventure/3/run.sh.template" lang="bash" />
</TabItem>
<TabItem label="project.json">
```diff lang="json"
// packages/story_api/project.json
{
  "name": "dungeon_adventure.story_api",
  ...
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/story_api/bundle"],
      "options": {
        "commands": [
          "uv export --frozen --no-dev --no-editable --project story_api -o dist/packages/story_api/bundle/requirements.txt",
          "uv pip install -n --no-installer-metadata --no-compile-bytecode --python-platform x86_64-manylinux2014 --target dist/packages/story_api/bundle -r dist/packages/story_api/bundle/requirements.txt",
+          "copyfiles -f packages/story_api/run.sh dist/packages/story_api/bundle"
        ],
        "parallel": false
      },
      "dependsOn": ["compile"]
    },
    ...
  }
}
```
</TabItem>
</Tabs>

### ë°°í¬ ë° í…ŒìŠ¤íŠ¸

ë¨¼ì € ì½”ë“œë² ì´ìŠ¤ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤:

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
ë¦°íŠ¸ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ìë™ìœ¼ë¡œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

ë°°í¬ëŠ” ì™„ë£Œê¹Œì§€ ì•½ 2ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.

<Drawer title="ë°°í¬ ëª…ë ¹ì–´" trigger="ëª¨ë“  ìŠ¤íƒì„ í•œ ë²ˆì— ë°°í¬í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì„ ë³´ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”.">

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ CDK ì• í”Œë¦¬ì¼€ì´ì…˜ì— í¬í•¨ëœ ëª¨ë“  ìŠ¤íƒì„ ë°°í¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

ì¸í”„ë¼ í”„ë¡œë•ì…˜ ìŠ¤íƒ(`infra-prod` ë“±)ì„ ë³„ë„ë¡œ ë¶„ë¦¬í•˜ëŠ” ê²½ìš° `--all` í”Œë˜ê·¸ê°€ ì›ì¹˜ ì•ŠëŠ” ë°°í¬ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ **ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤**!

</Drawer>

ë°°í¬ê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒê³¼ ìœ ì‚¬í•œ ì¶œë ¥ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì¼ë¶€ ê°’ì€ í¸ì§‘ë¨):

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX = https://xxx.lambda-url.ap-southeast-2.on.aws/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

ë‹¤ìŒ ë°©ë²•ìœ¼ë¡œ APIë¥¼ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
<ul>
<li>FastApi ì„œë²„ì˜ ë¡œì»¬ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‹œì‘í•˜ê³  `curl`ë¡œ API í˜¸ì¶œ</li>
<li>
<Drawer title="Sigv4 í™œì„±í™” curl" trigger="ë°°í¬ëœ APIë¥¼ sigv4 í™œì„±í™” curlë¡œ ì§ì ‘ í˜¸ì¶œ">
`.bashrc` íŒŒì¼ì— ë‹¤ìŒ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜(`source` ì‹¤í–‰ í•„ìš”), ëª…ë ¹ì–´ ì‹¤í–‰ í„°ë¯¸ë„ì— ì§ì ‘ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

sigv4 ì¸ì¦ curl ìš”ì²­ì€ ë‹¤ìŒ ì˜ˆì‹œì™€ ê°™ì´ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤:

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### ìŠ¤íŠ¸ë¦¬ë° Lambda í•¨ìˆ˜ URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="ë¡œì»¬">
  ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¡œì»¬ FastAPI ì„œë²„ ì‹œì‘:
    <NxCommands commands={["run dungeon_adventure.story_api:serve"]} />

    FastAPI ì„œë²„ê°€ ì‹¤í–‰ë˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ í˜¸ì¶œ:

    ```bash
    curl -N -X POST http://127.0.0.1:8000/story/generate \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="ë°°í¬ ë²„ì „">
```bash "https://xxx.lambda-url.ap-southeast-2.on.aws/" "ap-southeast-2"
acurl ap-southeast-2 lambda -N -X POST \
  https://xxx.lambda-url.ap-southeast-2.on.aws/story/generate \
  -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
  -H "Content-Type: application/json"
```
    <Aside type="caution">
    CDK ë°°í¬ ì¶œë ¥ê°’ `dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX`ì„ ì‚¬ìš©í•˜ì—¬ URL ìë¦¬ í‘œì‹œìë¥¼ êµì²´í•˜ê³  ë¦¬ì „ì„ ì ì ˆíˆ ì„¤ì •í•˜ì„¸ìš”.
    </Aside>
  </TabItem>
</Tabs>

ëª…ë ¹ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ë©´ ë‹¤ìŒê³¼ ìœ ì‚¬í•œ ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```
UnnamedHero stood tall, his cape billowing in the wind....
```

ì¶•í•˜í•©ë‹ˆë‹¤. FastAPIë¥¼ ì‚¬ìš©í•œ ì²« ë²ˆì§¸ APIë¥¼ êµ¬ì¶•í•˜ê³  ë°°í¬í–ˆìŠµë‹ˆë‹¤! ğŸ‰ğŸ‰ğŸ‰
---
title: "AIåœ°ç‰¢æ¸¸æˆ"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºäººå·¥æ™ºèƒ½é©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒã€‚"
---

import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2EDiff from '@components/e2e-diff.astro';
import E2ECode from '@components/e2e-code.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## æ¨¡å—äºŒï¼šæ¸¸æˆAPIå®ç°

æˆ‘ä»¬å°†ä»å®ç°æ¸¸æˆAPIå¼€å§‹ã€‚ä¸ºæ­¤ï¼Œæ€»å…±éœ€è¦åˆ›å»º4ä¸ªAPIï¼š

1. `createGame` - åˆ›å»ºæ–°çš„æ¸¸æˆå®ä¾‹ã€‚
2. `queryGames` - è¿”å›åˆ†é¡µçš„å·²ä¿å­˜æ¸¸æˆåˆ—è¡¨ã€‚
3. `saveAction` - ä¿å­˜æŒ‡å®šæ¸¸æˆçš„æ“ä½œè®°å½•ã€‚
4. `queryActions` - è¿”å›åˆ†é¡µçš„æŒ‡å®šæ¸¸æˆæ‰€æœ‰æ“ä½œè®°å½•ã€‚

### APIæ¨¡å¼å®šä¹‰

ä¸ºäº†å®šä¹‰APIçš„è¾“å…¥è¾“å‡ºï¼Œæˆ‘ä»¬ä½¿ç”¨[Zod](https://zod.dev/)åœ¨`packages/game-api/schema/src`é¡¹ç›®ä¸­åˆ›å»ºæ¨¡å¼ï¼š

<Tabs>
  <TabItem label="types/action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/types/action.ts.template" />
  </TabItem>
  <TabItem label="types/common.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/types/common.ts.template" />
  </TabItem>
  <TabItem label="types/game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/types/game.ts.template" />
  </TabItem>
  <TabItem label="index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/schema/index.ts.old.template" after="dungeon-adventure/2/schema/index.ts.template" />
  </TabItem>
</Tabs>

åŒæ—¶å¯ä»¥åˆ é™¤`./procedures/echo.ts`æ–‡ä»¶ï¼Œå› ä¸ºæœ¬é¡¹ç›®ä¸ä¼šä½¿ç”¨å®ƒã€‚

<Aside type="tip">
å¦‚ä¸Šæ‰€ç¤ºï¼Œæ¯ä¸ªZodæ¨¡å¼å®šä¹‰åï¼Œæˆ‘ä»¬éƒ½é€šè¿‡`z.TypeOf`è¯­æ³•å¯¼å‡ºå¯¹åº”æ¥å£ã€‚è¿™è®©æˆ‘ä»¬æ— éœ€é‡å¤å·¥ä½œå³å¯å°†Zodå®šä¹‰è½¬æ¢ä¸ºTypeScriptæ¥å£ï¼
</Aside>

### å®ä½“å»ºæ¨¡

åº”ç”¨çš„ERå›¾å¦‚ä¸‹ï¼š

<Image class="centered-image white-bg" src={dungeonAdventureErPng} alt="dungeon-adventure-er.png" width="400" height="300" />

æˆ‘ä»¬å°†ä½¿ç”¨DynamoDBå®ç°æ•°æ®åº“ï¼Œå¹¶é‡‡ç”¨[ElectroDB](https://electrodb.dev/en/core-concepts/introduction/)å®¢æˆ·ç«¯åº“ç®€åŒ–æ“ä½œã€‚é¦–å…ˆéœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…`electrodb`ï¼š

<InstallCommand pkg="electrodb @aws-sdk/client-dynamodb" />

<Aside>
æ‰€æœ‰ä¾èµ–é¡¹éƒ½æ·»åŠ åˆ°æ ¹ç›®å½•çš„`package.json`ä¸­ï¼Œå› ä¸º`@aws/nx-plugin`éµå¾ª[å•ç‰ˆæœ¬ç­–ç•¥](https://nx.dev/concepts/decisions/dependency-management#single-version-policy)åŸåˆ™ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<Link path="guides/typescript-project#dependencies">TypeScripté¡¹ç›®æŒ‡å—</Link>ã€‚
</Aside>

ç°åœ¨æ ¹æ®ERå›¾ï¼Œåœ¨`packages/game-api/backend/src/entities`ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹æ–‡ä»¶å®šä¹‰ElectroDBå®ä½“ï¼š

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/action.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/game.ts.template" />
  </TabItem>
</Tabs>

ElectroDBåŠŸèƒ½å¼ºå¤§ï¼Œä¸ä»…èƒ½å®šä¹‰ç±»å‹ï¼Œè¿˜èƒ½ä¸ºæ—¶é—´æˆ³ç­‰å­—æ®µæä¾›é»˜è®¤å€¼ã€‚æ­¤å¤–ï¼ŒElectroDBé‡‡ç”¨DynamoDBæœ€ä½³å®è·µâ€”â€”[å•è¡¨è®¾è®¡](https://electrodb.dev/en/core-concepts/single-table-relationships/)ã€‚

<Aside>
è™½ç„¶ElectroDBæ”¯æŒ[é›†åˆ](https://electrodb.dev/en/modeling/collections/)ï¼Œä½†æœ¬æ•™ç¨‹ä¸ºç®€åŒ–æµç¨‹æš‚ä¸ä½¿ç”¨ã€‚
</Aside>

### å°†DynamoDBå®¢æˆ·ç«¯æ³¨å…¥tRPCä¸Šä¸‹æ–‡

ç”±äºæ¯ä¸ªæµç¨‹éƒ½éœ€è¦è®¿é—®DynamoDBå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå•ä¸€å®ä¾‹å¹¶é€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’ã€‚åœ¨`packages/game-api/backend/src`ä¸­è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

<Tabs>
  <TabItem label="middleware/dynamodb.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/middleware/dynamodb.ts.template" />

è¯¥æ’ä»¶ç”¨äºåˆ›å»º`DynamoDBClient`å¹¶æ³¨å…¥åˆ°ä¸Šä¸‹æ–‡ä¸­ã€‚
  </TabItem>
  <TabItem label="middleware/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/middleware/index.ts.old.template" after="dungeon-adventure/2/middleware/index.ts.template" />

æ‰©å±•`IMiddlewareContext`æ¥å£ä»¥æ·»åŠ `IDynamoDBContext`ã€‚
  </TabItem>
  <TabItem label="init.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/init.ts.old.template" after="dungeon-adventure/2/init.ts.template" />

DynamoDBæ’ä»¶å·²é›†æˆã€‚

<Aside>
`concat` APIå°†ä¸­é—´ä»¶ç»‘å®šåˆ°å®šä¹‰çš„æµç¨‹ã€‚è¯¦æƒ…è¯·å‚è€ƒ[concatæŒ‡å—](https://trpc.io/docs/server/middlewares#concat)ã€‚
</Aside>
  </TabItem>
</Tabs>

### å®šä¹‰æµç¨‹

ç°åœ¨å®ç°APIæ–¹æ³•ã€‚åœ¨`packages/game-api/backend/src/procedures`ä¸­è¿›è¡Œä»¥ä¸‹ä¿®æ”¹ï¼š

<Tabs>
  <TabItem label="query-actions.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-actions.ts.template" />
  </TabItem>
  <TabItem label="query-games.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-games.ts.template" />
  </TabItem>
  <TabItem label="save-action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-action.ts.template" />
  </TabItem>
  <TabItem label="save-game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-game.ts.template" />
  </TabItem>
</Tabs>

åŒæ—¶å¯åˆ é™¤`echo.ts`æ–‡ä»¶ï¼ˆä½äº`packages/game-api/backend/src/procedures`ï¼‰ï¼Œæœ¬é¡¹ç›®ä¸å†ä½¿ç”¨ã€‚

### è·¯ç”±é…ç½®

å®Œæˆæµç¨‹å®šä¹‰åï¼Œå°†å…¶æ¥å…¥APIã€‚æŒ‰ä»¥ä¸‹æ–¹å¼æ›´æ–°æ–‡ä»¶ï¼š

<E2EDiff lang="typescript" before="dungeon-adventure/2/router.ts.old.template" after="dungeon-adventure/2/router.ts.template" />

### åŸºç¡€è®¾æ–½

æœ€åæ›´æ–°åŸºç¡€è®¾æ–½ä»¥åˆ›å»ºDynamoDBè¡¨å¹¶æˆäºˆGameAPIæ“ä½œæƒé™ã€‚ä¿®æ”¹`packages/infra/src`å¦‚ä¸‹ï¼š

<Tabs>
  <TabItem label="constructs/electrodb-table.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/constructs/electrodb-table.ts.template" />
  </TabItem>
  <TabItem label="stacks/application-stack.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/1/application-stack.ts.template" after="dungeon-adventure/2/stacks/application-stack.ts.template" />

:::note
æ³¨æ„ï¼šç”±äºæ¯ä¸ªæµç¨‹ç”±ç‹¬ç«‹Lambdaå‡½æ•°å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œæ ¹æ®æµç¨‹å®ç°ä»…åˆ†é…å¿…è¦çš„è¯»å†™æƒé™ã€‚
:::
  </TabItem>
</Tabs>

### éƒ¨ç½²ä¸æµ‹è¯•

é¦–å…ˆæ„å»ºä»£ç åº“ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
è‹¥é‡åˆ°linté”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

é¦–æ¬¡éƒ¨ç½²çº¦éœ€8åˆ†é’Ÿï¼Œåç»­éƒ¨ç½²çº¦2åˆ†é’Ÿã€‚

:::tip
è‹¥ä»…ä¿®æ”¹Lambdaå‡½æ•°ä»£ç ï¼Œæ„å»ºåå¯ä½¿ç”¨`--hotswap`æ ‡å¿—å¿«é€Ÿéƒ¨ç½²ï¼ˆçº¦2-3ç§’ï¼‰ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox --hotswap']} />
:::

<Drawer title="éƒ¨ç½²å‘½ä»¤" trigger="ç‚¹å‡»æŸ¥çœ‹æ‰¹é‡éƒ¨ç½²è¯¦æƒ…">

å¯è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²CDKåº”ç”¨ä¸­çš„æ‰€æœ‰å †æ ˆï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

**ä¸å»ºè®®**æ­¤æ“ä½œï¼Œå› ä¸ºè‹¥å°†ä¸åŒç¯å¢ƒï¼ˆå¦‚ç”Ÿäº§ç¯å¢ƒinfra-prodï¼‰ä½œä¸ºç‹¬ç«‹å †æ ˆï¼Œ`--all`æ ‡å¿—ä¼šè§¦å‘æ‰€æœ‰éƒ¨ç½²ï¼Œå¯èƒ½å¯¼è‡´æ„å¤–ç»“æœï¼

</Drawer>

éƒ¨ç½²å®Œæˆåå°†çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox

âœ¨  éƒ¨ç½²æ—¶é—´: 354ç§’

è¾“å‡º:
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•APIï¼š
<ul>
<li>å¯åŠ¨æœ¬åœ°tRPCåç«¯å®ä¾‹ï¼Œä½¿ç”¨`curl`è°ƒç”¨API</li>
<li>
<Drawer title="å¯ç”¨Sigv4ç­¾åçš„curl" trigger="è°ƒç”¨å·²éƒ¨ç½²çš„Sigv4ç­¾åAPI">
å¯å°†ä»¥ä¸‹è„šæœ¬æ·»åŠ åˆ°`.bashrc`æ–‡ä»¶ï¼ˆå¹¶æ‰§è¡Œ`source`ï¼‰ï¼Œæˆ–ç›´æ¥åœ¨ç»ˆç«¯ä¸­ç²˜è´´ï¼š

```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### APIç½‘å…³
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Lambdaå‡½æ•°URLæµå¼ä¼ è¾“
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="æœ¬åœ°æµ‹è¯•">
    è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨`game-api`æœ¬åœ°æœåŠ¡ï¼š

    <NxCommands highlights={['dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY']} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY"}} commands={["run @dungeon-adventure/game-api:serve"]} />

    <Aside type="caution">
    ä½¿ç”¨CDKéƒ¨ç½²è¾“å‡ºä¸­çš„`dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX`å€¼æ›¿æ¢é«˜äº®å ä½ç¬¦ã€‚
    </Aside>

    æœåŠ¡å¯åŠ¨åæ‰§è¡Œï¼š

    ```bash
    curl -X GET 'http://localhost:2022/games.query?input=%7B%7D'
    ```
  </TabItem>
  <TabItem label="äº‘ç«¯æµ‹è¯•">
```bash "https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/" "ap-southeast-2"
acurl ap-southeast-2 execute-api -X GET 'https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/games.query?input=%7B%7D'
```
    <Aside type="caution">
    ä½¿ç”¨CDKè¾“å‡ºä¸­çš„`dungeon-adventure-infra-sandbox.GameApiGameApiEndpointXXX`å€¼æ›¿æ¢é«˜äº®å ä½ç¬¦ï¼Œå¹¶è®¾ç½®æ­£ç¡®åŒºåŸŸã€‚
    </Aside>
  </TabItem>
</Tabs>

:::note
æµ‹è¯•æ—¶ä¼ é€’çš„`%7B%7D`æ˜¯URIç¼–ç çš„ç©ºJSONå¯¹è±¡(`{}`)ã€‚
:::

è‹¥æ‰§è¡ŒæˆåŠŸï¼Œå°†è¿”å›ï¼š

```json
{"result":{"data":{"items":[],"cursor":null}}}
```

æ­å–œï¼Œä½ å·²æˆåŠŸä½¿ç”¨tRPCæ„å»ºå¹¶éƒ¨ç½²é¦–ä¸ªAPIï¼ğŸ‰ğŸ‰ğŸ‰
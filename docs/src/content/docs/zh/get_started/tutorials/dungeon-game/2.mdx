---
title: "AIåœ°ç‰¢æ¸¸æˆ"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºäººå·¥æ™ºèƒ½é©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒã€‚"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Link from '@components/link.astro';
import Drawer from '@components/drawer.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2EDiff from '@components/e2e-diff.astro';
import E2ECode from '@components/e2e-code.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## æ¨¡å— 2ï¼šæ¸¸æˆ API å®ç°

æˆ‘ä»¬å°†ä»å®ç°æ¸¸æˆ API å¼€å§‹ã€‚ä¸ºæ­¤éœ€è¦æ€»å…±åˆ›å»º 4 ä¸ª APIï¼š

1. `createGame` - ç”¨äºåˆ›å»ºæ–°æ¸¸æˆå®ä¾‹
2. `queryGames` - è¿”å›åˆ†é¡µçš„å·²ä¿å­˜æ¸¸æˆåˆ—è¡¨
3. `saveAction` - ä¿å­˜æŒ‡å®šæ¸¸æˆçš„æ“ä½œè®°å½•
4. `queryActions` - è¿”å›æŒ‡å®šæ¸¸æˆç›¸å…³çš„åˆ†é¡µæ“ä½œè®°å½•

### API æ¨¡å¼å®šä¹‰

æˆ‘ä»¬å°†åœ¨ `packages/game-api/schema/src` é¡¹ç›®ä¸­ä½¿ç”¨ [Zod](https://zod.dev/) åˆ›å»ºæ¨¡å¼æ¥å®šä¹‰ API çš„è¾“å…¥è¾“å‡ºï¼š

<Tabs>
  <TabItem label="types/action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/types/action.ts.template" />
  </TabItem>
  <TabItem label="types/common.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/types/common.ts.template" />
  </TabItem>
  <TabItem label="types/game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/schema/types/game.ts.template" />
  </TabItem>
  <TabItem label="index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/schema/index.ts.old.template" after="dungeon-adventure/2/schema/index.ts.template" />
  </TabItem>
</Tabs>

å¯ä»¥åˆ é™¤ `./procedures/echo.ts` æ–‡ä»¶ï¼Œå› ä¸ºæœ¬é¡¹ç›®ä¸ä¼šä½¿ç”¨å®ƒã€‚

<Aside type="tip">
å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ª Zod æ¨¡å¼å®šä¹‰å¯¼å‡ºä½¿ç”¨ `z.TypeOf` è¯­æ³•ç”Ÿæˆçš„æ¥å£ã€‚è¿™èƒ½ç›´æ¥å°† Zod å®šä¹‰è½¬æ¢ä¸º TypeScript æ¥å£ï¼Œé¿å…é‡å¤å·¥ä½œï¼
</Aside>

### å®ä½“å»ºæ¨¡

åº”ç”¨ç¨‹åºçš„ ER å›¾å¦‚ä¸‹ï¼š

<Image class="centered-image white-bg" src={dungeonAdventureErPng} alt="dungeon-adventure-er.png" width="400" height="300" />

æˆ‘ä»¬å°†ä½¿ç”¨ DynamoDB å®ç°æ•°æ®åº“ï¼Œå¹¶é€šè¿‡ [ElectroDB](https://electrodb.dev/en/core-concepts/introduction/) å®¢æˆ·ç«¯åº“ç®€åŒ–æ“ä½œã€‚é¦–å…ˆè¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£… `electrodb`ï¼š

<InstallCommand pkg="electrodb @aws-sdk/client-dynamodb" />

<Aside>
æ‰€æœ‰ä¾èµ–é¡¹éƒ½æ·»åŠ åˆ°æ ¹ç›®å½•çš„ `package.json` ä¸­ï¼Œå› ä¸º `@aws/nx-plugin` éµå¾ª[å•ä¸€ç‰ˆæœ¬ç­–ç•¥](https://nx.dev/concepts/decisions/dependency-management#single-version-policy)åŸåˆ™ã€‚æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ<Link path="guides/typescript-project#dependencies">TypeScript é¡¹ç›®æŒ‡å—</Link>ã€‚
</Aside>

ç°åœ¨æ ¹æ®ä¸Šè¿° ER å›¾ï¼Œåœ¨ `packages/game-api/backend/src/entities` ç›®å½•ä¸‹åˆ›å»ºä»¥ä¸‹æ–‡ä»¶æ¥å®šä¹‰ ElectroDB å®ä½“ï¼š

<Tabs>
  <TabItem label="action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/action.ts.template" />
  </TabItem>
  <TabItem label="game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/entities/game.ts.template" />
  </TabItem>
</Tabs>

ElectroDB åŠŸèƒ½å¼ºå¤§ï¼Œä¸ä»…å¯ä»¥å®šä¹‰ç±»å‹ï¼Œè¿˜èƒ½ä¸ºæ—¶é—´æˆ³ç­‰å­—æ®µæä¾›é»˜è®¤å€¼ã€‚åŒæ—¶å®ƒé‡‡ç”¨ DynamoDB æœ€ä½³å®è·µçš„[å•è¡¨è®¾è®¡](https://electrodb.dev/en/core-concepts/single-table-relationships/)ã€‚

<Aside>
è™½ç„¶ ElectroDB æ”¯æŒ[é›†åˆ](https://electrodb.dev/en/modeling/collections/)ï¼Œä½†æœ¬æ•™ç¨‹ä¸ºç®€åŒ–æµç¨‹æš‚ä¸ä½¿ç”¨ã€‚
</Aside>

### å°† DynamoDB å®¢æˆ·ç«¯æ³¨å…¥ tRPC ä¸Šä¸‹æ–‡

ç”±äºæ¯ä¸ªæµç¨‹éƒ½éœ€è¦è®¿é—® DynamoDB å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå•ä¾‹å®¢æˆ·ç«¯å¹¶é€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’ã€‚åœ¨ `packages/game-api/backend/src` ä¸­åšå¦‚ä¸‹ä¿®æ”¹ï¼š

<Tabs>
  <TabItem label="middleware/dynamodb.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/middleware/dynamodb.ts.template" />

æ­¤æ’ä»¶ç”¨äºåˆ›å»º `DynamoDBClient` å¹¶æ³¨å…¥ä¸Šä¸‹æ–‡ã€‚
  </TabItem>
  <TabItem label="middleware/index.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/middleware/index.ts.old.template" after="dungeon-adventure/2/middleware/index.ts.template" />

æ‰©å±• `IMiddlewareContext` ä»¥æ·»åŠ  `IDynamoDBContext`ã€‚
  </TabItem>
  <TabItem label="init.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/2/init.ts.old.template" after="dungeon-adventure/2/init.ts.template" />

å®Œæˆ DynamoDB æ’ä»¶çš„æ³¨å…¥ã€‚

<Aside>
`concat` API å°†ä¸­é—´ä»¶ç»‘å®šåˆ°å®šä¹‰çš„æµç¨‹ã€‚è¯¦æƒ…è¯·å‚è€ƒ[concat æŒ‡å—](https://trpc.io/docs/server/middlewares#concat)ã€‚
</Aside>
  </TabItem>
</Tabs>

### å®šä¹‰æµç¨‹

ç°åœ¨å®ç° API æ–¹æ³•ã€‚åœ¨ `packages/game-api/backend/src/procedures` ä¸­åšå¦‚ä¸‹ä¿®æ”¹ï¼š

<Tabs>
  <TabItem label="query-actions.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-actions.ts.template" />
  </TabItem>
  <TabItem label="query-games.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/query-games.ts.template" />
  </TabItem>
  <TabItem label="save-action.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-action.ts.template" />
  </TabItem>
  <TabItem label="save-game.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/procedures/save-game.ts.template" />
  </TabItem>
</Tabs>

å¯ä»¥åˆ é™¤ `packages/game-api/backend/src/procedures` ä¸­çš„ `echo.ts` æ–‡ä»¶ã€‚

### è·¯ç”±é…ç½®

å®Œæˆæµç¨‹å®šä¹‰åï¼Œæ›´æ–°è·¯ç”±æ–‡ä»¶ï¼š

<E2EDiff lang="typescript" before="dungeon-adventure/2/router.ts.old.template" after="dungeon-adventure/2/router.ts.template" />

### åŸºç¡€è®¾æ–½

æœ€åæ›´æ–°åŸºç¡€è®¾æ–½ä»¥åˆ›å»º DynamoDB è¡¨å¹¶ä¸ºæ¸¸æˆ API é…ç½®æƒé™ã€‚ä¿®æ”¹ `packages/infra/src` ä¸­çš„æ–‡ä»¶ï¼š

<Tabs>
  <TabItem label="constructs/electrodb-table.ts">
<E2ECode lang="typescript" path="dungeon-adventure/2/constructs/electrodb-table.ts.template" />
  </TabItem>
  <TabItem label="stacks/application-stack.ts">
<E2EDiff lang="typescript" before="dungeon-adventure/1/application-stack.ts.template" after="dungeon-adventure/2/stacks/application-stack.ts.template" />

:::note
ç”±äºæ¯ä¸ªæµç¨‹ç”±ç‹¬ç«‹çš„ lambda å‡½æ•°å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥éµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œæ ¹æ®æµç¨‹å®ç°ä»…åˆ†é…å¿…è¦çš„è¯»å†™æƒé™ã€‚
:::
  </TabItem>
</Tabs>

### éƒ¨ç½²ä¸æµ‹è¯•

é¦–å…ˆæ„å»ºä»£ç åº“ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
å¦‚é‡ lint é”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

é¦–æ¬¡éƒ¨ç½²çº¦éœ€ 8 åˆ†é’Ÿï¼Œåç»­éƒ¨ç½²çº¦ 2 åˆ†é’Ÿã€‚

:::tip
å¦‚éœ€è¿­ä»£ä¿®æ”¹ lambda å‡½æ•°ä»£ç ï¼Œå¯åœ¨æ„å»ºåä½¿ç”¨ `--hotswap` æ ‡å¿—è¿›è¡Œçƒ­éƒ¨ç½²ï¼ˆ2-3 ç§’ï¼‰ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox --hotswap']} />
:::

<Drawer title="éƒ¨ç½²å‘½ä»¤" trigger="ç‚¹å‡»æŸ¥çœ‹æ‰¹é‡éƒ¨ç½²è¯¦æƒ…">

å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤ä¸€æ¬¡æ€§éƒ¨ç½²æ‰€æœ‰å †æ ˆï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

**ä¸æ¨èæ­¤æ–¹å¼**ï¼Œå› ä¸ºå®é™…åœºæ™¯ä¸­å¯èƒ½éœ€è¦åˆ†é˜¶æ®µéƒ¨ç½²ä¸åŒç¯å¢ƒï¼ˆå¦‚ç”Ÿäº§ç¯å¢ƒ infra-prodï¼‰ã€‚ä½¿ç”¨ `--all` ä¼šå°è¯•éƒ¨ç½²æ‰€æœ‰å †æ ˆï¼Œå¯èƒ½å¯¼è‡´æ„å¤–éƒ¨ç½²ï¼

</Drawer>

éƒ¨ç½²å®Œæˆåå°†çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox

âœ¨  éƒ¨ç½²æ—¶é—´ï¼š354ç§’

è¾“å‡ºï¼š
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯• APIï¼š
<ul>
<li>å¯åŠ¨ tRPC åç«¯æœ¬åœ°å®ä¾‹å¹¶ä½¿ç”¨ `curl` è°ƒç”¨ API</li>
<li>
<Drawer title="æ”¯æŒ Sigv4 ç­¾åçš„ curl" trigger="è°ƒç”¨å·²éƒ¨ç½² API">
å¯å°†ä»¥ä¸‹è„šæœ¬æ·»åŠ è‡³ `.bashrc` æ–‡ä»¶ï¼ˆéœ€æ‰§è¡Œ `source`ï¼‰æˆ–ç›´æ¥ç²˜è´´åˆ°ç»ˆç«¯ï¼š
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### API ç½‘å…³
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Lambda å‡½æ•° URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="æœ¬åœ°æµ‹è¯•">
    è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨æœ¬åœ° `game-api` æœåŠ¡ï¼š

    <NxCommands highlights={['dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY']} env={{TABLE_NAME:"dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY"}} commands={["run @dungeon-adventure/game-api-backend:serve"]} />

    <Aside type="caution">
    è¯·ä½¿ç”¨ CDK éƒ¨ç½²è¾“å‡ºä¸­çš„ `dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX` å€¼æ›¿æ¢é«˜äº®å ä½ç¬¦ã€‚
    </Aside>

    æœåŠ¡å¯åŠ¨åæ‰§è¡Œæµ‹è¯•å‘½ä»¤ï¼š
    ```bash
    curl -X GET 'http://localhost:2022/games.query?input=%7B%7D'
    ```
  </TabItem>
  <TabItem label="äº‘ç«¯æµ‹è¯•">
```bash "https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/" "ap-southeast-2"
acurl ap-southeast-2 execute-api -X GET 'https://xxx.execute-api.ap-southeast-2.amazonaws.com/prod/games.query?input=%7B%7D'
```
    <Aside type="caution">
    è¯·ä½¿ç”¨ CDK éƒ¨ç½²è¾“å‡ºä¸­çš„ `dungeon-adventure-infra-sandbox.GameApiGameApiEndpointXXX` å€¼æ›¿æ¢é«˜äº®å ä½ç¬¦ï¼Œå¹¶è®¾ç½®æ­£ç¡®åŒºåŸŸã€‚
    </Aside>
  </TabItem>
</Tabs>

:::note
æµ‹è¯• API æ—¶ä¼ é€’çš„ `%7B%7D` æ˜¯ URI ç¼–ç çš„ç©º JSON å¯¹è±¡ï¼ˆ`{}`ï¼‰ã€‚
:::

æˆåŠŸæ‰§è¡Œåå°†æ”¶åˆ°å¦‚ä¸‹å“åº”ï¼š
```json
{"result":{"data":{"items":[],"cursor":null}}}
```

æ­å–œï¼ä½ å·²æˆåŠŸä½¿ç”¨ tRPC æ„å»ºå¹¶éƒ¨ç½²äº†ç¬¬ä¸€ä¸ª APIï¼ğŸ‰ğŸ‰ğŸ‰
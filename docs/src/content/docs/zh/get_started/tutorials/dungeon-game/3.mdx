---
title: "AIåœ°ç‰¢æ¸¸æˆ"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºäººå·¥æ™ºèƒ½é©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒã€‚"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## æ¨¡å—ä¸‰ï¼šæ•…äº‹APIå®ç°

<Aside type="caution">
è¯·ç¡®ä¿å·²æŒ‰ç…§[æœ¬æŒ‡å—](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html)ä¸­çš„æ­¥éª¤æˆæƒè®¿é—®**Anthropic Claude 3.5 Sonnet v2**æ¨¡å‹ã€‚
</Aside>

StoryApiåŒ…å«ä¸€ä¸ªå•ç‹¬çš„`generate_story` APIï¼Œå®ƒæ ¹æ®ç»™å®šçš„`Game`å’Œä¸Šä¸‹æ–‡ä¸­çš„`Action`åˆ—è¡¨æ¨è¿›æ•…äº‹æƒ…èŠ‚ã€‚è¯¥APIå°†ä½¿ç”¨Python/FastAPIå®ç°ä¸ºæµå¼APIï¼Œå¹¶æ¼”ç¤ºå¦‚ä½•å¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œä¿®æ”¹ä»¥é€‚åº”å®é™…éœ€æ±‚ã€‚

### APIå®ç°

è¦åˆ›å»ºAPIï¼Œé¦–å…ˆéœ€è¦å®‰è£…å‡ ä¸ªé¢å¤–ä¾èµ–ï¼š

- `boto3` ç”¨äºè°ƒç”¨Amazon Bedrockï¼›
- `uvicorn` ä¸[Lambda Web Adapter (LWA)](https://github.com/awslabs/aws-lambda-web-adapter)é…åˆä½¿ç”¨æ¥å¯åŠ¨APIï¼›
- `copyfiles` æ˜¯npmä¾èµ–é¡¹ï¼Œç”¨äºåœ¨æ›´æ–°`bundle`ä»»åŠ¡æ—¶æ”¯æŒè·¨å¹³å°æ–‡ä»¶å¤åˆ¶ã€‚

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…ä¾èµ–ï¼š

<NxCommands commands={["run dungeon_adventure.story_api:add --args boto3 uvicorn"]} />
<InstallCommand pkg="copyfiles" dev />

ç°åœ¨æ›¿æ¢`packages/story_api/story_api/main.py`å†…å®¹å¦‚ä¸‹ï¼š

```python
// packages/story_api/story_api/main.py
import json

from boto3 import client
from fastapi.responses import PlainTextResponse, StreamingResponse
from pydantic import BaseModel

from .init import app, lambda_handler

handler = lambda_handler

bedrock = client('bedrock-runtime')

class Action(BaseModel):
    role: str
    content: str

class StoryRequest(BaseModel):
    genre: str
    playerName: str
    actions: list[Action]

async def bedrock_stream(request: StoryRequest):
    messages = [
        {"role": "user", "content": "Continue or create a new story..."}
    ]

    for action in request.actions:
        messages.append({"role": action.role, "content": action.content})

    response = bedrock.invoke_model_with_response_stream(
        modelId='anthropic.claude-3-sonnet-20240229-v1:0',
        body=json.dumps({
            "system":f"""
            You are running an AI text adventure game in the {request.genre} genre.
            Player: {request.playerName}. Return less than 200 characters of text.
            """,
            "messages": messages,
            "max_tokens": 1000,
            "temperature": 0.7,
            "anthropic_version": "bedrock-2023-05-31"
        })
    )

    stream = response.get('body')
    if stream:
        for event in stream:
            chunk = event.get('chunk')
            if chunk:
                message = json.loads(chunk.get("bytes").decode())
                if message['type'] == "content_block_delta":
                    yield message['delta']['text'] or ""
                elif message['type'] == "message_stop":
                    yield "\n"

@app.post("/story/generate",
          openapi_extra={'x-streaming': True},
          response_class=PlainTextResponse)
def generate_story(request: StoryRequest) -> str:
    return StreamingResponse(bedrock_stream(request), media_type="text/plain")
```

ä»£ç åˆ†æï¼š
- ä½¿ç”¨`x-streaming`è®¾ç½®æ ‡è®°æµå¼APIï¼Œç¡®ä¿ç”Ÿæˆå®¢æˆ·ç«¯SDKæ—¶ä¿æŒç±»å‹å®‰å…¨
- APIé€šè¿‡`media_type="text/plain"`å’Œ`response_class=PlainTextResponse`è¿”å›çº¯æ–‡æœ¬æµ

:::note
æ¯æ¬¡ä¿®æ”¹FastAPIåéƒ½éœ€è¦é‡æ–°æ„å»ºé¡¹ç›®æ‰èƒ½åœ¨ç½‘ç«™ç”Ÿæˆçš„å®¢æˆ·ç«¯ä¸­çœ‹åˆ°å˜æ›´ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹æ–‡ç»§ç»­ä¿®æ”¹åç»Ÿä¸€æ„å»ºã€‚
:::

### åŸºç¡€è®¾æ–½

å…ˆå‰è®¾ç½®çš„<Link path="get_started/tutorials/dungeon-game/1#game-ui-infrastructure">åŸºç¡€è®¾æ–½</Link>å‡è®¾æ‰€æœ‰APIéƒ½é€šè¿‡API Gatewayä¸Lambdaé›†æˆã€‚ç”±äºAPI Gatewayä¸æ”¯æŒæµå¼å“åº”ï¼Œ`story_api`å°†æ”¹ç”¨[æ”¯æŒå“åº”æµä¼ è¾“çš„Lambda Function URL](https://docs.aws.amazon.com/lambda/latest/dg/configuration-response-streaming.html)ã€‚

æ›´æ–°CDKæ„é€ å¦‚ä¸‹ï¼š

<Tabs>
<TabItem label="story-api.ts">
```ts
// packages/common/constructs/src/app/apis/story-api.ts
import { Duration, Stack, CfnOutput } from 'aws-cdk-lib';
import { IGrantable, Grant } from 'aws-cdk-lib/aws-iam';
import {
  Runtime,
  Code,
  Tracing,
  LayerVersion,
  FunctionUrlAuthType,
  InvokeMode,
  Function,
} from 'aws-cdk-lib/aws-lambda';
import { Construct } from 'constructs';
import url from 'url';
import { RuntimeConfig } from '../../core/runtime-config.js';

export class StoryApi extends Construct {
  public readonly handler: Function;

  constructor(scope: Construct, id: string) {
    super(scope, id);

    this.handler = new Function(this, 'Handler', {
      runtime: Runtime.PYTHON_3_12,
      handler: 'run.sh',
      code: Code.fromAsset(
        url.fileURLToPath(
          new URL(
            '../../../../../../dist/packages/story_api/bundle',
            import.meta.url,
          ),
        ),
      ),
      timeout: Duration.seconds(30),
      tracing: Tracing.ACTIVE,
      environment: {
        AWS_CONNECTION_REUSE_ENABLED: '1',
      },
    });

    const stack = Stack.of(this);
    this.handler.addLayers(
      LayerVersion.fromLayerVersionArn(
        this,
        'LWALayer',
        `arn:aws:lambda:${stack.region}:753240598075:layer:LambdaAdapterLayerX86:24`,
      ),
    );
    this.handler.addEnvironment('PORT', '8000');
    this.handler.addEnvironment('AWS_LWA_INVOKE_MODE', 'response_stream');
    this.handler.addEnvironment('AWS_LAMBDA_EXEC_WRAPPER', '/opt/bootstrap');
    const functionUrl = this.handler.addFunctionUrl({
      authType: FunctionUrlAuthType.AWS_IAM,
      invokeMode: InvokeMode.RESPONSE_STREAM,
      cors: {
        allowedOrigins: ['*'],
        allowedHeaders: [
          'authorization',
          'content-type',
          'x-amz-content-sha256',
          'x-amz-date',
          'x-amz-security-token',
        ],
      },
    });

    new CfnOutput(this, 'StoryApiUrl', { value: functionUrl.url });

    // Register the API URL in runtime configuration for client discovery
    RuntimeConfig.ensure(this).config.apis = {
      ...RuntimeConfig.ensure(this).config.apis!,
      StoryApi: functionUrl.url,
    };
  }

  public grantInvokeAccess(grantee: IGrantable) {
    Grant.addToPrincipal({
      grantee,
      actions: ['lambda:InvokeFunctionUrl'],
      resourceArns: [this.handler.functionArn],
      conditions: {
        StringEquals: {
          'lambda:FunctionUrlAuthType': 'AWS_IAM',
        },
      },
    });
  }
}

```
</TabItem>
<TabItem label="application-stack.ts">
```diff lang="typescript"
// packages/infra/src/stacks/application-stack.ts
import {
  GameApi,
  GameUI,
  StoryApi,
  UserIdentity,
} from ':dungeon-adventure/common-constructs';
import * as cdk from 'aws-cdk-lib';
import { Construct } from 'constructs';
import { ElectrodbDynamoTable } from '../constructs/electrodb-table.js';
+import { PolicyStatement, Effect } from 'aws-cdk-lib/aws-iam';

export class ApplicationStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // The code that defines your stack goes here
    const userIdentity = new UserIdentity(this, 'UserIdentity');

    const electroDbTable = new ElectrodbDynamoTable(this, 'ElectroDbTable');

    const gameApi = new GameApi(this, 'GameApi', {
      integrations: GameApi.defaultIntegrations(this)
        .withDefaultOptions({
          environment: {
            TABLE_NAME: electroDbTable.tableName,
          },
        })
        .build(),
    });

    // Grant read/write access to each handler depending on the permissions it requires
    electroDbTable.grantReadData(gameApi.integrations['actions.query'].handler);
    electroDbTable.grantReadData(gameApi.integrations['games.query'].handler);
    electroDbTable.grantReadWriteData(
      gameApi.integrations['actions.save'].handler,
    );
    electroDbTable.grantReadWriteData(
      gameApi.integrations['games.save'].handler,
    );

-    const storyApi = new StoryApi(this, 'StoryApi', {
-      integrations: StoryApi.defaultIntegrations(this).build(),
-    });
+    const storyApi = new StoryApi(this, 'StoryApi');
+    storyApi.handler.addToRolePolicy(
+      new PolicyStatement({
+        effect: Effect.ALLOW,
+        actions: ['bedrock:InvokeModelWithResponseStream'],
+        resources: [
+          'arn:aws:bedrock:*::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0',
+        ],
+      }),
+    );

    // grant our authenticated role access to invoke our APIs
    [storyApi, gameApi].forEach((api) =>
      api.grantInvokeAccess(userIdentity.identityPool.authenticatedRole),
    );

    // Ensure this is instantiated last so our runtime-config.json can be automatically configured
    new GameUI(this, 'GameUI');
  }
}

```
</TabItem>
</Tabs>

æ›´æ–°`story_api`ä»¥æ”¯æŒ[Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)éƒ¨ç½²ï¼š

<Tabs>
<TabItem label="run.sh">
```bash
// packages/story_api/run.sh
#!/bin/bash

PATH=$PATH:$LAMBDA_TASK_ROOT/bin \
    PYTHONPATH=$PYTHONPATH:/opt/python:$LAMBDA_RUNTIME_DIR \
    exec python -m uvicorn --port=$PORT story_api.main:app
```
</TabItem>
<TabItem label="project.json">
```diff lang="json"
// packages/story_api/project.json
{
  "name": "dungeon_adventure.story_api",
  "$schema": "../../node_modules/nx/schemas/project-schema.json",
  "projectType": "application",
  "sourceRoot": "packages/story_api/story_api",
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/story_api/bundle"],
      "options": {
        "commands": [
          "uv export --frozen --no-dev --no-editable --project story_api -o dist/packages/story_api/bundle/requirements.txt",
          "uv pip install -n --no-installer-metadata --no-compile-bytecode --python-platform x86_64-manylinux2014 --python `uv python pin` --target dist/packages/story_api/bundle -r dist/packages/story_api/bundle/requirements.txt",
+          "copyfiles -f packages/story_api/run.sh dist/packages/story_api/bundle"
        ],
        "parallel": false
      },
      "dependsOn": ["compile"]
    },
    ...
  }
}
```
</TabItem>
</Tabs>

### éƒ¨ç½²ä¸æµ‹è¯•

é¦–å…ˆæ„å»ºä»£ç åº“ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
è‹¥é‡åˆ°linté”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

é€šè¿‡ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

éƒ¨ç½²çº¦éœ€2åˆ†é’Ÿå®Œæˆã€‚

<Drawer title="éƒ¨ç½²å‘½ä»¤" trigger="ç‚¹å‡»æŸ¥çœ‹å¤šæ ˆåŒæ—¶éƒ¨ç½²è¯¦æƒ…">

å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²CDKåº”ç”¨ä¸­çš„æ‰€æœ‰æ ˆï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

ç”±äºå¯èƒ½æ¶‰åŠå¤šç¯å¢ƒéƒ¨ç½²ï¼ˆå¦‚`infra-prod`ï¼‰ï¼Œ**ä¸å»ºè®®**ä½¿ç”¨`--all`å‚æ•°ï¼Œä»¥å…è§¦å‘æ„å¤–éƒ¨ç½²ã€‚

</Drawer>

éƒ¨ç½²å®Œæˆåå°†çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox

âœ¨  Deployment time: 354s

Outputs:
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX = https://xxx.lambda-url.ap-southeast-2.on.aws/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•APIï¼š
<ul>
<li>å¯åŠ¨æœ¬åœ°FastAPIæœåŠ¡å™¨ä½¿ç”¨`curl`è°ƒç”¨</li>
<li>
<Drawer title="Sigv4ç­¾åcurlè°ƒç”¨" trigger="ç›´æ¥è°ƒç”¨å·²éƒ¨ç½²API">
åœ¨`.bashrc`ä¸­æ·»åŠ è„šæœ¬ï¼ˆæ‰§è¡Œ`source`ï¼‰æˆ–åœ¨ç»ˆç«¯ç›´æ¥ç²˜è´´ï¼š
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### Lambdaæµå¼URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="æœ¬åœ°æµ‹è¯•">
  è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨FastAPIæœåŠ¡å™¨ï¼š
    <NxCommands commands={["run dungeon_adventure.story_api:serve"]} />

    æ‰§è¡Œè°ƒç”¨å‘½ä»¤ï¼š

    ```bash
    curl -N -X POST http://127.0.0.1:8000/story/generate \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="äº‘ç«¯æµ‹è¯•">
```bash "https://xxx.lambda-url.ap-southeast-2.on.aws/" "ap-southeast-2"
acurl ap-southeast-2 lambda -N -X POST \
  https://xxx.lambda-url.ap-southeast-2.on.aws/story/generate \
  -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
  -H "Content-Type: application/json"
```
    <Aside type="caution">
    ä½¿ç”¨CDKéƒ¨ç½²è¾“å‡ºçš„`dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX`å€¼æ›¿æ¢URLå ä½ç¬¦ï¼Œå¹¶è®¾ç½®æ­£ç¡®åŒºåŸŸã€‚
    </Aside>
  </TabItem>
</Tabs>

æˆåŠŸæ‰§è¡Œåå°†çœ‹åˆ°æµå¼å“åº”ï¼š

```
UnnamedHero stood tall, his cape billowing in the wind....
```

æ­å–œï¼æ‚¨å·²æˆåŠŸä½¿ç”¨FastAPIæ„å»ºå¹¶éƒ¨ç½²é¦–ä¸ªæµå¼APIï¼ğŸ‰ğŸ‰ğŸ‰
---
title: "AIåœ°ç‰¢æ¸¸æˆ"
description: "ä½¿ç”¨ @aws/nx-plugin æ„å»ºäººå·¥æ™ºèƒ½é©±åŠ¨çš„åœ°ç‰¢å†’é™©æ¸¸æˆçš„æ¼”ç»ƒã€‚"
---



import { Aside, Code, FileTree, Steps, Tabs, TabItem } from '@astrojs/starlight/components';
import { Image } from 'astro:assets';
import Drawer from '@components/drawer.astro';
import Link from '@components/link.astro';
import RunGenerator from '@components/run-generator.astro';
import NxCommands from '@components/nx-commands.astro';
import InstallCommand from '@components/install-command.astro';
import E2ECode from '@components/e2e-code.astro';
import E2EDiff from '@components/e2e-diff.astro';

import dungeonAdventureArchitecturePng from '@assets/dungeon-game-architecture.png'
import dungeonAdventureErPng from '@assets/dungeon-adventure-er.png'
import baselineWebsitePng from '@assets/baseline-website.png'
import baselineGamePng from '@assets/baseline-game.png'
import nxGraphPng from '@assets/nx-graph.png'
import gameSelectPng from '@assets/game-select.png'
import gameConversationPng from '@assets/game-conversation.png'

## æ¨¡å—3ï¼šæ•…äº‹APIå®ç°

<Aside type="caution">
è¯·ç¡®ä¿å·²æŒ‰ç…§[æœ¬æŒ‡å—](https://docs.aws.amazon.com/bedrock/latest/userguide/model-access-modify.html)ä¸­çš„æ­¥éª¤æˆäºˆå¯¹**Anthropic Claude 3.5 Sonnet v2**æ¨¡å‹çš„è®¿é—®æƒé™ã€‚
</Aside>

StoryApiåŒ…å«ä¸€ä¸ªå•ç‹¬çš„API`generate_story`ï¼Œè¯¥APIæ¥æ”¶ä¸€ä¸ª`Game`å’Œç”¨äºä¸Šä¸‹æ–‡çš„`Action`åˆ—è¡¨æ¥æ¨è¿›æ•…äº‹æƒ…èŠ‚ã€‚æˆ‘ä»¬å°†ä½¿ç”¨Python/FastAPIå°†æ­¤APIå®ç°ä¸ºæµå¼APIï¼Œå¹¶æ¼”ç¤ºå¦‚ä½•å¯¹ç”Ÿæˆçš„ä»£ç è¿›è¡Œè°ƒæ•´ä»¥æ»¡è¶³å®é™…éœ€æ±‚ã€‚

### APIå®ç°

è¦åˆ›å»ºAPIï¼Œé¦–å…ˆéœ€è¦å®‰è£…ä¸¤ä¸ªé¢å¤–çš„ä¾èµ–é¡¹ï¼š

- `boto3`ç”¨äºè°ƒç”¨Amazon Bedrockï¼›
- `uvicorn`ä¸[Lambda Web Adapter (LWA)](https://github.com/awslabs/aws-lambda-web-adapter)é…åˆä½¿ç”¨æ¥å¯åŠ¨APIï¼›
- `copyfiles`æ˜¯npmä¾èµ–é¡¹ï¼Œç”¨äºåœ¨æ›´æ–°`bundle`ä»»åŠ¡æ—¶æ”¯æŒè·¨å¹³å°æ–‡ä»¶å¤åˆ¶ã€‚

è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…è¿™äº›ä¾èµ–é¡¹ï¼š

<NxCommands commands={["run dungeon_adventure.story_api:add --args boto3 uvicorn"]} />
<InstallCommand pkg="copyfiles" dev />

ç°åœ¨æ›¿æ¢`packages/story_api/story_api`ç›®å½•ä¸­çš„ä»¥ä¸‹æ–‡ä»¶å†…å®¹ï¼š

<Tabs>
<TabItem label="main.py">
<E2ECode path="dungeon-adventure/3/main.py.template" lang="python" />
</TabItem>
<TabItem label="init.py">
<E2ECode path="dungeon-adventure/3/init.py.template" lang="python" />

:::note
ä¸Šè¿°å¯¹`init.py`çš„ä¿®æ”¹ç§»é™¤äº†CORSä¸­é—´ä»¶ï¼Œä»¥é¿å…ä¸Lambdaå‡½æ•°URLè‡ªèº«çš„CORSå¤´å¤„ç†äº§ç”Ÿå†²çªã€‚
:::

</TabItem>
</Tabs>

ä»£ç åˆ†æï¼š

- ä½¿ç”¨`x-streaming`è®¾ç½®æ ‡è®°ä¸ºæµå¼APIï¼Œåœ¨ç”Ÿæˆå®¢æˆ·ç«¯SDKæ—¶ä¿æŒç±»å‹å®‰å…¨çš„æµå¼æ¶ˆè´¹
- APIé€šè¿‡`media_type="text/plain"`å’Œ`response_class=PlainTextResponse`å®šä¹‰è¿”å›çº¯æ–‡æœ¬æµ

:::note
æ¯æ¬¡ä¿®æ”¹FastAPIåéƒ½éœ€è¦é‡æ–°æ„å»ºé¡¹ç›®ï¼Œæ‰èƒ½åœ¨ç½‘ç«™ç”Ÿæˆçš„å®¢æˆ·ç«¯ä¸­çœ‹åˆ°å˜æ›´ã€‚

æˆ‘ä»¬å°†åœ¨ä¸‹é¢è¿›è¡Œæ›´å¤šä¿®æ”¹åå†è¿›è¡Œé‡å»ºã€‚
:::

### åŸºç¡€è®¾æ–½

å…ˆå‰è®¾ç½®çš„<Link path="get_started/tutorials/dungeon-game/1#game-ui-infrastructure">åŸºç¡€è®¾æ–½</Link>å‡è®¾æ‰€æœ‰APIéƒ½é€šè¿‡API Gatewayä¸Lambdaå‡½æ•°é›†æˆã€‚å¯¹äº`story_api`ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨[æ”¯æŒå“åº”æµå¼çš„Lambdaå‡½æ•°URL](https://docs.aws.amazon.com/lambda/latest/dg/configuration-response-streaming.html)æ¥æ›¿ä»£API Gatewayã€‚

æ›´æ–°CDKæ„é€ å¦‚ä¸‹ï¼š

<Tabs>
<TabItem label="story-api.ts">
<E2ECode path="dungeon-adventure/3/story-api.ts.template" lang="typescript" />
</TabItem>
<TabItem label="application-stack.ts">
<E2EDiff before="dungeon-adventure/2/stacks/application-stack.ts.template" after="dungeon-adventure/3/application-stack.ts.template" lang="typescript" />
</TabItem>
</Tabs>

æ›´æ–°`story_api`ä»¥æ”¯æŒ[Lambda Web Adapter](https://github.com/awslabs/aws-lambda-web-adapter)éƒ¨ç½²ï¼š

<Tabs>
<TabItem label="run.sh">
<E2ECode path="dungeon-adventure/3/run.sh.template" lang="bash" />
</TabItem>
<TabItem label="project.json">
```diff lang="json"
// packages/story_api/project.json
{
  "name": "dungeon_adventure.story_api",
  ...
  "targets": {
    ...
    "bundle": {
      "cache": true,
      "executor": "nx:run-commands",
      "outputs": ["{workspaceRoot}/dist/packages/story_api/bundle"],
      "options": {
        "commands": [
          "uv export --frozen --no-dev --no-editable --project story_api -o dist/packages/story_api/bundle/requirements.txt",
          "uv pip install -n --no-installer-metadata --no-compile-bytecode --python-platform x86_64-manylinux2014 --target dist/packages/story_api/bundle -r dist/packages/story_api/bundle/requirements.txt",
+          "copyfiles -f packages/story_api/run.sh dist/packages/story_api/bundle"
        ],
        "parallel": false
      },
      "dependsOn": ["compile"]
    },
    ...
  }
}
```
</TabItem>
</Tabs>

### éƒ¨ç½²ä¸æµ‹è¯•

é¦–å…ˆæ„å»ºä»£ç åº“ï¼š

<NxCommands commands={['run-many --target build --all']} />

<Aside type="tip">
è‹¥é‡åˆ°linté”™è¯¯ï¼Œå¯è¿è¡Œä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¿®å¤ï¼š

<NxCommands commands={['run-many --target lint --configuration=fix --all']} />
</Aside>

è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy dungeon-adventure-infra-sandbox']} />

éƒ¨ç½²è¿‡ç¨‹çº¦éœ€2åˆ†é’Ÿã€‚

<Drawer title="éƒ¨ç½²å‘½ä»¤" trigger="ç‚¹å‡»æŸ¥çœ‹åŒæ—¶éƒ¨ç½²æ‰€æœ‰å †æ ˆçš„è¯¦ç»†ä¿¡æ¯">

å¯è¿è¡Œä»¥ä¸‹å‘½ä»¤éƒ¨ç½²CDKåº”ç”¨åŒ…å«çš„æ‰€æœ‰å †æ ˆï¼š

<NxCommands commands={['run @dungeon-adventure/infra:deploy --all']} />

**ä¸å»ºè®®**æ­¤æ“ä½œï¼Œå› ä¸ºå½“æ‚¨å°†éƒ¨ç½²é˜¶æ®µæ‹†åˆ†ä¸ºç‹¬ç«‹å †æ ˆï¼ˆå¦‚`infra-prod`ï¼‰æ—¶ï¼Œ`--all`æ ‡å¿—ä¼šå°è¯•éƒ¨ç½²æ‰€æœ‰å †æ ˆï¼Œå¯èƒ½å¯¼è‡´æ„å¤–éƒ¨ç½²ï¼

</Drawer>

éƒ¨ç½²å®Œæˆåå°†çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼ˆéƒ¨åˆ†å€¼å·²è„±æ•ï¼‰ï¼š

```bash
dungeon-adventure-infra-sandbox
dungeon-adventure-infra-sandbox: deploying... [2/2]

 âœ…  dungeon-adventure-infra-sandbox

âœ¨  éƒ¨ç½²æ—¶é—´ï¼š354ç§’

è¾“å‡ºï¼š
dungeon-adventure-infra-sandbox.ElectroDbTableTableNameXXX = dungeon-adventure-infra-sandbox-ElectroDbTableXXX-YYY
dungeon-adventure-infra-sandbox.GameApiEndpointXXX = https://xxx.execute-api.region.amazonaws.com/prod/
dungeon-adventure-infra-sandbox.GameUIDistributionDomainNameXXX = xxx.cloudfront.net
dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX = https://xxx.lambda-url.ap-southeast-2.on.aws/
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityIdentityPoolIdXXX = region:xxx
dungeon-adventure-infra-sandbox.UserIdentityUserIdentityUserPoolIdXXX = region_xxx
```

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼æµ‹è¯•APIï¼š
<ul>
<li>å¯åŠ¨FastAPIæœ¬åœ°å®ä¾‹å¹¶ä½¿ç”¨`curl`è°ƒç”¨</li>
<li>
<Drawer title="å¯ç”¨Sigv4ç­¾åçš„curl" trigger="ç›´æ¥è°ƒç”¨å·²éƒ¨ç½²APIï¼ˆä½¿ç”¨Sigv4ç­¾åcurlï¼‰">

<Tabs>
  <TabItem label="Bash/Linux/macOS">
å¯å°†ä»¥ä¸‹è„šæœ¬æ·»åŠ åˆ°`.bashrc`æ–‡ä»¶ï¼ˆå¹¶`source`ï¼‰ï¼Œæˆ–ç›´æ¥åœ¨ç»ˆç«¯ç²˜è´´ï¼š
```bash
// ~/.bashrc
acurl () {
    REGION=$1
    SERVICE=$2
    shift; shift;
    curl --aws-sigv4 "aws:amz:$REGION:$SERVICE" --user "$(aws configure get aws_access_key_id):$(aws configure get aws_secret_access_key)" -H "X-Amz-Security-Token: $(aws configure get aws_session_token)" "$@"
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### API Gateway
```bash
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### æµå¼Lambdaå‡½æ•°URL
```bash
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
  <TabItem label="Windows PowerShell">
å¯å°†ä»¥ä¸‹å‡½æ•°æ·»åŠ åˆ°PowerShellé…ç½®æ–‡ä»¶æˆ–ç›´æ¥ç²˜è´´ï¼š
```powershell
function acurl {
    param(
        [Parameter(Mandatory=$true)][string]$Region,
        [Parameter(Mandatory=$true)][string]$Service,
        [Parameter(ValueFromRemainingArguments=$true)][string[]]$CurlArgs
    )
    
    $AccessKey = aws configure get aws_access_key_id
    $SecretKey = aws configure get aws_secret_access_key
    $SessionToken = aws configure get aws_session_token
    
    & curl --aws-sigv4 "aws:amz:$Region`:$Service" --user "$AccessKey`:$SecretKey" -H "X-Amz-Security-Token: $SessionToken" @CurlArgs
}
```

è°ƒç”¨ç¤ºä¾‹ï¼š

###### API Gateway
```powershell
acurl ap-southeast-2 execute-api -X GET https://xxx
```

###### æµå¼Lambdaå‡½æ•°URL
```powershell
acurl ap-southeast-2 lambda -N -X POST https://xxx
```
  </TabItem>
</Tabs>

</Drawer>
</li>
</ul>

<Tabs>
  <TabItem label="æœ¬åœ°">
  è¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨FastAPIæœåŠ¡ï¼š
    <NxCommands commands={["run dungeon_adventure.story_api:serve"]} />

    æœåŠ¡å¯åŠ¨åæ‰§è¡Œï¼š
    
    ```bash
    curl -N -X POST http://127.0.0.1:8000/story/generate \
      -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
      -H "Content-Type: application/json"
    ```
  </TabItem>
  <TabItem label="å·²éƒ¨ç½²">
```bash "https://xxx.lambda-url.ap-southeast-2.on.aws/" "ap-southeast-2"
acurl ap-southeast-2 lambda -N -X POST \
  https://xxx.lambda-url.ap-southeast-2.on.aws/story/generate \
  -d '{"genre":"superhero", "actions":[], "playerName":"UnnamedHero"}' \
  -H "Content-Type: application/json"
```
    <Aside type="caution">
    è¯·ä½¿ç”¨CDKéƒ¨ç½²è¾“å‡ºä¸­çš„`dungeon-adventure-infra-sandbox.StoryApiStoryApiUrlXXX`å€¼æ›¿æ¢é«˜äº®URLå ä½ç¬¦ï¼Œå¹¶æ­£ç¡®è®¾ç½®åŒºåŸŸã€‚
    </Aside>
  </TabItem>
</Tabs>

æˆåŠŸæ‰§è¡Œåå°†çœ‹åˆ°æµå¼å“åº”ï¼š

```
UnnamedHeroè¿é£è€Œç«‹ï¼ŒæŠ«é£çŒçŒä½œå“....
```

æ­å–œï¼æ‚¨å·²æˆåŠŸä½¿ç”¨FastAPIæ„å»ºå¹¶éƒ¨ç½²äº†é¦–ä¸ªæµå¼APIï¼ğŸ‰ğŸ‰ğŸ‰